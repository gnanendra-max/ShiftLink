<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>ShiftLink | Part-Time & Flexible Jobs in Bengaluru</title>
    <meta name="description" content="ShiftLink is a live job platform connecting students and professionals with part-time, flexible, and gig work from local businesses in Bengaluru.">
    
    <!-- Google Site Verification Tag -->
    <meta name="google-site-verification" content="aRXxgTqEIcLfgc-_xrOG6MjQCkKKE6Hk1ShP8HmNPkc" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
            color: #334155; /* Slate 700 */
        }
        .header {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #e2e8f0; /* Slate 200 */
        }
        .cta-button {
            transition: all 0.2s ease;
            background-image: linear-gradient(to right, #f59e0b, #fbbf24);
            color: #422006; /* Amber 950 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
        }
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 25px rgba(245, 158, 11, 0.3);
        }
        .cta-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .secondary-button {
             background-color: #e2e8f0; /* Slate 200 */
             color: #475569; /* Slate 600 */
             border-radius: 0.5rem;
        }
        .secondary-button:hover {
            background-color: #cbd5e1; /* Slate 300 */
        }
        .job-card, .choice-card, .referral-card, .applicant-card, .category-card {
            background-color: #ffffff; /* White */
            border: 1px solid #e2e8f0; /* Slate 200 */
            border-radius: 0.75rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .job-card:hover, .choice-card:hover, .referral-card:hover, .applicant-card:hover, .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.08);
            border-color: #f59e0b; /* Amber 500 */
        }
        .input-field {
            background-color: #f8fafc; /* Slate 50 */
            border: 1px solid #cbd5e1; /* Slate 300 */
            color: #1e293b; /* Slate 800 */
            border-radius: 0.5rem;
        }
        .input-field:focus {
            --tw-ring-color: #f59e0b;
            border-color: #f59e0b;
        }
        .hero-gradient {
            background: #f8fafc;
            background: linear-gradient(145deg, #fefce8 0%, #f8fafc 100%);
        }
        .category-card img {
            transition: transform 0.3s ease;
        }
        .category-card:hover img {
            transform: scale(1.05);
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app-container" class="min-h-screen">

        <!-- Header -->
        <header class="header sticky top-0 z-40">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800 cursor-pointer" id="home-button">Shift<span class="text-amber-500">Link</span></h1>
                
                <!-- Main Navigation (shown on dashboard views) -->
                <div id="main-nav" class="hidden items-center space-x-4">
                    <button id="profile-button" class="font-semibold text-slate-600 hover:text-amber-500">My Profile</button>
                    <button id="refer-job-button" class="font-semibold text-slate-600 hover:text-amber-500">Refer a Job</button>
                    <span id="user-role-display" class="font-semibold text-slate-600 capitalize"></span>
                    <button id="logout-button" class="text-sm text-slate-500 hover:text-amber-500">Logout</button>
                </div>

                <!-- Secondary Navigation (shown on profile/applicants view) -->
                <div id="secondary-nav" class="hidden items-center space-x-4">
                    <button id="back-button" class="font-semibold text-slate-600 hover:text-amber-500 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back
                    </button>
                    <button id="logout-button-secondary" class="text-sm text-slate-500 hover:text-amber-500">Logout</button>
                </div>
            </nav>
        </header>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-white/70 z-50 flex items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-amber-500"></div>
        </div>

        <!-- Role Selection View (Logged Out) -->
        <div id="role-selection-view" class="hidden hero-gradient">
             <div class="container mx-auto px-6 py-20 md:py-28 text-center">
                <h2 class="text-4xl md:text-6xl font-extrabold text-slate-800 leading-tight mb-6">
                    Stop Searching. <br class="hidden md:block"> Start Connecting.
                </h2>
                <p class="max-w-3xl mx-auto text-lg md:text-xl text-slate-500 mb-12">
                   Finding flexible work or reliable part-time talent shouldn't be a struggle. We built ShiftLink to bridge this gap, instantly connecting skilled professionals with great companies for part-time and project-based roles. This is the future of work, simplified.
                </p>
                
                <!-- Dynamic Image Gallery -->
                <div class="mb-16">
                    <h3 class="text-2xl font-bold text-slate-700 mb-8">Or, start by exploring a category</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-5xl mx-auto">
                        <!-- Category Card 1: Cafe/Restaurant -->
                        <div class="category-card cursor-pointer group" data-category="Cafe">
                            <div class="relative overflow-hidden rounded-lg">
                                <img src="https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=2047&auto=format&fit=crop" class="w-full h-48 object-cover" alt="Barista making coffee">
                                <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all duration-300"></div>
                                <div class="absolute bottom-0 left-0 p-4">
                                    <h4 class="text-white text-xl font-bold">Cafe & Restaurant</h4>
                                </div>
                            </div>
                        </div>
                        <!-- Category Card 2: Retail -->
                        <div class="category-card cursor-pointer group" data-category="Retail">
                            <div class="relative overflow-hidden rounded-lg">
                                <img src="https://images.unsplash.com/photo-1556742111-a301076d9d18?q=80&w=2070&auto=format&fit=crop" class="w-full h-48 object-cover" alt="Retail assistant helping a customer">
                                <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all duration-300"></div>
                                <div class="absolute bottom-0 left-0 p-4">
                                    <h4 class="text-white text-xl font-bold">Retail</h4>
                                </div>
                            </div>
                        </div>
                        <!-- Category Card 3: Events -->
                        <div class="category-card cursor-pointer group" data-category="Event">
                             <div class="relative overflow-hidden rounded-lg">
                                <img src="https://images.unsplash.com/photo-1527529482837-4698179dc6ce?q=80&w=2070&auto=format&fit=crop" class="w-full h-48 object-cover" alt="Staff at a conference event">
                                <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all duration-300"></div>
                                <div class="absolute bottom-0 left-0 p-4">
                                    <h4 class="text-white text-xl font-bold">Events</h4>
                                </div>
                            </div>
                        </div>
                        <!-- Category Card 4: Office/Data -->
                        <div class="category-card cursor-pointer group" data-category="Data Entry">
                            <div class="relative overflow-hidden rounded-lg">
                                <img src="https://images.unsplash.com/photo-1554224155-1696413565d3?q=80&w=2070&auto=format&fit=crop" class="w-full h-48 object-cover" alt="Person doing data entry on a laptop">
                                <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all duration-300"></div>
                                <div class="absolute bottom-0 left-0 p-4">
                                    <h4 class="text-white text-xl font-bold">Office & Data</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                    <div id="select-seeker-button" class="choice-card cursor-pointer p-8 rounded-xl text-left">
                        <h3 class="text-2xl font-bold text-slate-800 mt-4 mb-2">I want to find a Job</h3>
                        <p class="text-slate-500">Discover flexible jobs from local businesses and companies.</p>
                        <p class="font-semibold text-amber-600 mt-4">Start Your Search →</p>
                    </div>
                     <div id="select-employer-button" class="choice-card cursor-pointer p-8 rounded-xl text-left">
                        <h3 class="text-2xl font-bold text-slate-800 mt-4 mb-2">I want to Hire Talent</h3>
                        <p class="text-slate-500">Post a job in minutes and find reliable candidates for your team.</p>
                        <p class="font-semibold text-amber-600 mt-4">Post a Job for Free →</p>
                    </div>
                </div>
                 <div class="mt-12">
                     <button id="select-referrer-button" class="font-semibold text-slate-600 hover:text-amber-500">Or, refer a job and earn rewards →</button>
                 </div>
                 
                <!-- Manifesto Section -->
                <div class="my-16 md:my-20 border-t border-b border-slate-200 bg-white py-12">
                    <div class="container mx-auto px-6 text-center max-w-4xl">
                        <h3 class="text-3xl font-bold text-slate-800">A Platform Built for the Indian Hustle</h3>
                        <p class="mt-6 text-lg text-slate-600">
                            <strong>Why can't India have its own professional network, built for our unique reality?</strong>
                        </p>
                        <p class="mt-4 text-slate-500">
                            Platforms like LinkedIn are designed for established, full-time careers. But that's not the full story of the Indian job market. The real story is in the millions of us who move to a new city, stay in a PG, and need a part-time job <em>right now</em> to pay the bills while we chase our dreams.
                        </p>
                         <p class="mt-4 text-slate-500">
                            That’s why ShiftLink was created. Not as another corporate job board, but as a platform built from the ground up for the Indian hustle. It's a place where a student, a recent graduate, or anyone needing flexible work can instantly connect with local businesses. This is a community network, built by someone who lives the same reality.
                        </p>
                    </div>
                </div>
                <!-- End Manifesto Section -->

                <!-- NEW: How It Works Section -->
                <div class="my-16 md:my-20">
                    <h3 class="text-3xl font-bold text-slate-800 text-center mb-12">How It Works</h3>
                    <div class="grid md:grid-cols-2 gap-10 max-w-5xl mx-auto text-left">
                        <div class="bg-white p-8 rounded-lg shadow-md">
                            <h4 class="text-2xl font-bold text-amber-600 mb-4">For Job Seekers</h4>
                            <ul class="space-y-3 text-slate-600">
                                <li class="flex items-start"><span class="font-bold text-amber-500 mr-3 mt-1">1.</span> <span><strong>Explore:</strong> Browse real-time job listings or search by category.</span></li>
                                <li class="flex items-start"><span class="font-bold text-amber-500 mr-3 mt-1">2.</span> <span><strong>Apply:</strong> Complete your profile and apply to any job with a single click.</span></li>
                                <li class="flex items-start"><span class="font-bold text-amber-500 mr-3 mt-1">3.</span> <span><strong>Connect:</strong> Get contacted directly by local businesses for your next gig.</span></li>
                            </ul>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-md">
                            <h4 class="text-2xl font-bold text-amber-600 mb-4">For Employers</h4>
                            <ul class="space-y-3 text-slate-600">
                                <li class="flex items-start"><span class="font-bold text-amber-500 mr-3 mt-1">1.</span> <span><strong>Post a Job:</strong> Describe your needs in our simple form—it takes less than 2 minutes.</span></li>
                                <li class="flex items-start"><span class="font-bold text-amber-500 mr-3 mt-1">2.</span> <span><strong>Review Applicants:</strong> See a list of motivated, local candidates who have applied.</span></li>
                                <li class="flex items-start"><span class="font-bold text-amber-500 mr-3 mt-1">3.</span> <span><strong>Hire Talent:</strong> Connect with the best applicants and fill your shifts quickly.</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- End How It Works Section -->

                <!-- NEW: Testimonials Section -->
                <div class="my-16 md:my-20">
                     <h3 class="text-3xl font-bold text-slate-800 text-center mb-12">What People Are Saying</h3>
                     <div class="grid md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                        <div class="bg-white p-8 rounded-lg shadow-md text-left">
                            <p class="text-slate-600 italic">"ShiftLink helped me find a weekend barista job in just two days. It was so much easier than searching on other sites!"</p>
                            <p class="mt-4 font-bold text-slate-700">- Priya K., Student in Koramangala</p>
                        </div>
                         <div class="bg-white p-8 rounded-lg shadow-md text-left">
                            <p class="text-slate-600 italic">"We needed staff for a last-minute event, and we found two reliable people through ShiftLink within hours. This platform is a lifesaver for our business."</p>
                            <p class="mt-4 font-bold text-slate-700">- Rohan S., Event Manager</p>
                        </div>
                     </div>
                </div>
                <!-- End Testimonials Section -->

                <!-- NEW: FAQ Section -->
                <div class="my-16 md:my-20 max-w-4xl mx-auto">
                    <h3 class="text-3xl font-bold text-slate-800 text-center mb-12">Frequently Asked Questions</h3>
                    <div class="space-y-4 text-left">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-lg text-slate-800">Is ShiftLink free to use?</h4>
                            <p class="mt-2 text-slate-600">Yes, ShiftLink is currently 100% free for both job seekers and employers. Our mission is to build the community first.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-lg text-slate-800">What kind of jobs are on the platform?</h4>
                            <p class="mt-2 text-slate-600">You'll find a wide range of part-time, flexible, and one-time gigs from local businesses, including roles in cafes, retail, events, data entry, and more.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-lg text-slate-800">How do I get paid?</h4>
                            <p class="mt-2 text-slate-600">ShiftLink is a platform that connects you with employers. All payment details and arrangements are handled directly between you and the business that hires you.</p>
                        </div>
                    </div>
                </div>
                <!-- End FAQ Section -->

            </div>
        </div>

        <!-- Job Seeker View -->
        <div id="seeker-view" class="hidden container mx-auto px-6 py-12">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                 <h2 class="text-3xl font-bold text-slate-800">Available Jobs</h2>
                 <div class="relative w-full md:w-1/3">
                    <input type="text" id="search-input" placeholder="Search 'Data Entry', 'IT Support', 'Barista'..." class="w-full pl-4 pr-10 py-3 rounded-lg focus:ring-2 input-field">
                    <svg class="absolute right-4 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                 </div>
            </div>
            <div id="job-listings-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
             <div id="no-jobs-message" class="hidden text-center py-16 bg-white rounded-lg">
                <p class="text-xl text-slate-500">No jobs have been posted yet.</p>
                <p class="mt-2 text-slate-400">Check back soon!</p>
            </div>
             <div id="no-search-results-message" class="hidden text-center py-16 bg-white rounded-lg">
                <p class="text-xl text-slate-500">No jobs match your search.</p>
            </div>
        </div>

        <!-- Employer View -->
        <div id="employer-view" class="hidden container mx-auto px-6 py-12">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-slate-800">Your Job Postings</h2>
                <button id="open-post-job-modal-button" class="cta-button font-bold rounded-lg px-6 py-3">Post a New Job</button>
            </div>
            <div id="employer-jobs-container" class="space-y-4"></div>
            <div id="no-employer-jobs-message" class="hidden text-center py-16 bg-white rounded-lg">
                <p class="text-xl text-slate-500">You haven't posted any jobs yet.</p>
            </div>
        </div>
        
        <!-- Applicants View -->
        <div id="applicants-view" class="hidden container mx-auto px-6 py-12">
            <h2 id="applicants-title" class="text-3xl font-bold text-slate-800 mb-8">Applicants</h2>
            <div id="applicants-container" class="space-y-4"></div>
            <div id="no-applicants-message" class="hidden text-center py-16 bg-white rounded-lg">
                <p class="text-xl text-slate-500">No one has applied to this job yet.</p>
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="hidden container mx-auto px-6 py-12">
            <h2 class="text-3xl font-bold text-slate-800 mb-8">Referred Job Leads</h2>
            <div id="referral-listings-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="no-referrals-message" class="hidden text-center py-16 bg-white rounded-lg">
                <p class="text-xl text-slate-500">No new job leads have been referred.</p>
            </div>
        </div>
        
        <!-- Profile View -->
        <div id="profile-view" class="hidden container mx-auto px-6 py-12">
            <h2 class="text-3xl font-bold text-slate-800 mb-8">Edit Your Profile</h2>
            <div id="profile-form-container" class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                <!-- Profile form will be injected here by JavaScript -->
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div id="post-job-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"></div>
    <div id="refer-job-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"></div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, updateDoc, arrayUnion, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCAEUjctGPFbs14JqPS2Za1M5pnKo87Wc0",
          authDomain: "shiftlink-5a6be.firebaseapp.com",
          projectId: "shiftlink-5a6be",
          storageBucket: "shiftlink-5a6be.appspot.com",
          messagingSenderId: "205455659811",
          appId: "1:205455659811:web:9e690d842b604b8336b296"
        };
        const appId = firebaseConfig.appId;
        const ADMIN_UID = "YOUR_ADMIN_UID_HERE"; 

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const mainNav = document.getElementById('main-nav');
        const secondaryNav = document.getElementById('secondary-nav');
        
        const roleSelectionView = document.getElementById('role-selection-view');
        const seekerView = document.getElementById('seeker-view');
        const employerView = document.getElementById('employer-view');
        const adminView = document.getElementById('admin-view');
        const profileView = document.getElementById('profile-view');
        const applicantsView = document.getElementById('applicants-view');
        
        const userRoleDisplay = document.getElementById('user-role-display');
        const jobListingsContainer = document.getElementById('job-listings-container');
        const employerJobsContainer = document.getElementById('employer-jobs-container');
        const referralListingsContainer = document.getElementById('referral-listings-container');
        const applicantsContainer = document.getElementById('applicants-container');
        const applicantsTitle = document.getElementById('applicants-title');
        
        // Buttons
        const homeButton = document.getElementById('home-button');
        const profileButton = document.getElementById('profile-button');
        const selectSeekerButton = document.getElementById('select-seeker-button');
        const selectEmployerButton = document.getElementById('select-employer-button');
        const selectReferrerButton = document.getElementById('select-referrer-button');
        const logoutButton = document.getElementById('logout-button');
        const logoutButtonSecondary = document.getElementById('logout-button-secondary');
        const referJobButton = document.getElementById('refer-job-button');
        const backButton = document.getElementById('back-button');
        
        // Modals
        const postJobModalContainer = document.getElementById('post-job-modal');
        const referJobModalContainer = document.getElementById('refer-job-modal');

        // Search
        const searchInput = document.getElementById('search-input');

        let currentUser = null;
        let userRole = null;
        let userData = {};
        let allJobs = [];
        let jobsUnsubscribe = null;
        let employerJobsUnsubscribe = null;
        let referralsUnsubscribe = null;
        let previousView = null;

        // --- UI Management ---
        function showView(view, fromView = null) {
            if (fromView) previousView = fromView;

            [loadingSpinner, roleSelectionView, seekerView, employerView, adminView, profileView, applicantsView].forEach(el => el.style.display = 'none');
            
            if (view === 'loading') {
                loadingSpinner.style.display = 'flex';
                mainNav.style.display = 'none';
                secondaryNav.style.display = 'none';
            } else if (view === 'roleSelection') {
                roleSelectionView.style.display = 'block';
                mainNav.style.display = 'none';
                secondaryNav.style.display = 'none';
            } else if (view === 'profile' || view === 'applicants') {
                document.getElementById(`${view}-view`).style.display = 'block';
                mainNav.style.display = 'none';
                secondaryNav.style.display = 'flex';
            } else {
                document.getElementById(`${view}-view`).style.display = 'block';
                mainNav.style.display = 'flex';
                secondaryNav.style.display = 'none';
            }
        }

        // --- App Initialization and Auth Handling ---
        async function mainAppLogic(user) {
            currentUser = user;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}`);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                userData = userDoc.data();
                userRole = userData.role;
                userRoleDisplay.textContent = userRole;
                
                if (userRole === 'seeker') showView('seeker');
                else if (userRole === 'employer') showView('employer');
                else if (userRole === 'admin') showView('admin');
                
                if (userRole !== 'admin') {
                    listenForJobs();
                    if (userRole === 'employer') fetchEmployerJobs();
                } else {
                    listenForReferrals();
                }
            } else {
                if (currentUser.uid === ADMIN_UID) {
                    await setDoc(userDocRef, { role: 'admin' });
                    mainAppLogic(user); // Re-run logic
                } else {
                    showView('roleSelection');
                }
            }
        }

        onAuthStateChanged(auth, async (user) => {
            showView('loading');
            try {
                if (user) {
                    await mainAppLogic(user);
                } else {
                    // This block runs on first visit or after logout
                    [jobsUnsubscribe, employerJobsUnsubscribe, referralsUnsubscribe].forEach(unsub => unsub && unsub());
                    await signInAnonymously(auth);
                    // onAuthStateChanged will be triggered again by signInAnonymously,
                    // so we don't need to do anything else here.
                }
            } catch (error) {
                console.error("Critical error in auth state handler:", error);
                showView('roleSelection'); // Fallback on any critical error
            }
        });

        async function handleRoleSelection(role, initialSearch = '') {
            showView('loading');
            try {
                if (!auth.currentUser) {
                    console.error("No user found during role selection. This should not happen.");
                    showView('roleSelection');
                    return;
                }
                const user = auth.currentUser;
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
                await setDoc(userDocRef, { role: role });
                
                // After setting the role, re-run the main app logic to load the correct view.
                await mainAppLogic(user);

                if (role === 'seeker' && initialSearch) {
                    setTimeout(() => {
                        searchInput.value = initialSearch;
                        searchInput.dispatchEvent(new Event('input'));
                    }, 100);
                }

            } catch (error) {
                console.error("Error during role selection:", error);
                showView('roleSelection');
            }
        }

        // --- Event Listeners ---
        selectSeekerButton.addEventListener('click', () => handleRoleSelection('seeker'));
        selectEmployerButton.addEventListener('click', () => handleRoleSelection('employer'));
        selectReferrerButton.addEventListener('click', () => openReferralModal());
        logoutButton.addEventListener('click', () => signOut(auth));
        logoutButtonSecondary.addEventListener('click', () => signOut(auth));
        homeButton.addEventListener('click', () => {
             if (currentUser && userRole) {
                showView(userRole);
             } else {
                showView('roleSelection');
             }
        });
        profileButton.addEventListener('click', () => {
            showView('profile', userRole);
            renderProfileForm();
        });
        backButton.addEventListener('click', () => showView(previousView || userRole));
        referJobButton.addEventListener('click', () => openReferralModal());
        
        document.querySelectorAll('.category-card').forEach(card => {
            card.addEventListener('click', () => {
                const category = card.dataset.category;
                handleRoleSelection('seeker', category);
            });
        });

        // --- Profile Functions ---
        function renderProfileForm() {
            const container = document.getElementById('profile-form-container');
            let formHTML = '';
            if (userRole === 'seeker') {
                formHTML = `
                    <form id="profile-form" class="space-y-4">
                        <div><label for="profile-name" class="block text-sm font-medium text-slate-600">Your Name</label><input type="text" id="profile-name" class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field" placeholder="e.g., Priya Kumar" value="${userData.name || ''}"></div>
                        <div><label for="profile-bio" class="block text-sm font-medium text-slate-600">Short Bio</label><textarea id="profile-bio" rows="3" class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field" placeholder="Tell us a little about yourself...">${userData.bio || ''}</textarea></div>
                        <div><label for="profile-skills" class="block text-sm font-medium text-slate-600">Key Skills</label><input type="text" id="profile-skills" class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field" placeholder="e.g., Customer Service, Data Entry" value="${(userData.skills || []).join(', ')}"></div>
                        <div class="flex justify-end space-x-4 pt-4">
                             <button type="button" id="profile-cancel-button" class="px-6 py-2 rounded-lg font-semibold secondary-button">Cancel</button>
                            <button type="submit" class="px-6 py-2 rounded-lg font-semibold cta-button">Save Profile</button>
                        </div>
                    </form>
                `;
            } else if (userRole === 'employer') {
                formHTML = `
                    <form id="profile-form" class="space-y-4">
                        <div><label for="profile-company-desc" class="block text-sm font-medium text-slate-600">Company Description</label><textarea id="profile-company-desc" rows="3" class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field" placeholder="Describe your business...">${userData.companyDescription || ''}</textarea></div>
                        <div><label for="profile-company-logo" class="block text-sm font-medium text-slate-600">Company Logo URL</label><input type="url" id="profile-company-logo" class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field" placeholder="https://example.com/logo.png" value="${userData.companyLogoUrl || ''}"></div>
                        <div class="flex justify-end space-x-4 pt-4">
                             <button type="button" id="profile-cancel-button" class="px-6 py-2 rounded-lg font-semibold secondary-button">Cancel</button>
                            <button type="submit" class="px-6 py-2 rounded-lg font-semibold cta-button">Save Profile</button>
                        </div>
                    </form>
                `;
            }
            container.innerHTML = formHTML;
            container.querySelector('#profile-form').addEventListener('submit', handleProfileSave);
            container.querySelector('#profile-cancel-button').addEventListener('click', () => showView(userRole));
        }

        async function handleProfileSave(e) {
            e.preventDefault();
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}`);
            let profileData = {};

            if (userRole === 'seeker') {
                const skills = document.getElementById('profile-skills').value.split(',').map(s => s.trim()).filter(s => s);
                profileData = {
                    name: document.getElementById('profile-name').value,
                    bio: document.getElementById('profile-bio').value,
                    skills: skills
                };
            } else if (userRole === 'employer') {
                profileData = {
                    companyDescription: document.getElementById('profile-company-desc').value,
                    companyLogoUrl: document.getElementById('profile-company-logo').value
                };
            }

            await updateDoc(userDocRef, profileData);
            alert('Profile saved successfully!');
            userData = {...userData, ...profileData};
            showView(userRole);
        }

        // --- Job & Applicant Functions ---
        function createJobCard(job, isEmployerView = false) {
            const card = document.createElement('div');
            card.className = 'job-card p-6 rounded-lg flex flex-col border-t-4 border-amber-400';
            const applicationsCount = job.applications ? job.applications.length : 0;
            const hasApplied = job.applications && job.applications.includes(currentUser?.uid);

            card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="text-xl font-bold text-slate-800">${job.title}</h3>
                    <p class="text-md text-slate-600 font-semibold mt-1">${job.companyName}</p>
                    <div class="flex items-center text-sm text-slate-500 mt-2 gap-4">
                        <span>📍 ${job.location}</span>
                        <span>🕒 ${job.hours}</span>
                        <span class="font-bold text-amber-700">${job.pay}</span>
                    </div>
                    <p class="text-slate-500 my-4">${job.description}</p>
                </div>
                ${isEmployerView 
                    ? `<button data-job-id="${job.id}" data-job-title="${job.title}" class="view-applicants-button w-full mt-4 font-bold py-2 cta-button">${applicationsCount} Application(s)</button>` 
                    : `<button data-job-id="${job.id}" class="apply-button w-full mt-4 font-bold py-2 cta-button" ${hasApplied ? 'disabled' : ''}>${hasApplied ? 'Applied' : 'Apply Now'}</button>`
                }`;

            if (isEmployerView) {
                card.querySelector('.view-applicants-button').addEventListener('click', (e) => {
                    const jobId = e.target.dataset.jobId;
                    const jobTitle = e.target.dataset.jobTitle;
                    const job = allJobs.find(j => j.id === jobId);
                    showView('applicants', 'employer');
                    displayApplicants(job.applications || [], jobTitle);
                });
            } else {
                if (!hasApplied) {
                    card.querySelector('.apply-button').addEventListener('click', async (e) => {
                        e.target.disabled = true;
                        e.target.textContent = 'Applying...';
                        await applyForJob(job.id);
                        e.target.textContent = 'Applied!';
                    });
                }
            }
            return card;
        }

        async function displayApplicants(applicantIds, jobTitle) {
            applicantsTitle.textContent = `Applicants for "${jobTitle}"`;
            applicantsContainer.innerHTML = '';
            document.getElementById('no-applicants-message').style.display = applicantIds.length === 0 ? 'block' : 'none';

            if (applicantIds.length > 0) {
                for (const userId of applicantIds) {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const applicantData = userDoc.data();
                        const card = document.createElement('div');
                        card.className = 'applicant-card p-6';
                        card.innerHTML = `
                            <h4 class="text-lg font-bold text-slate-800">${applicantData.name || 'Anonymous User'}</h4>
                            <p class="text-slate-600 mt-2">${applicantData.bio || 'No bio provided.'}</p>
                            <div class="mt-4">
                                ${ (applicantData.skills || []).map(skill => `<span class="inline-block bg-amber-100 text-amber-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${skill}</span>`).join('') }
                            </div>
                        `;
                        applicantsContainer.appendChild(card);
                    }
                }
            }
        }

        function displayJobs(jobs, container, isEmployerView = false) {
            container.innerHTML = '';
            const noMsgId = isEmployerView ? 'no-employer-jobs-message' : (container === jobListingsContainer ? 'no-jobs-message' : 'no-search-results-message');
            const noMsg = document.getElementById(noMsgId);

            if (jobs.length === 0) {
                if (noMsg) noMsg.style.display = 'block';
                 if (container === jobListingsContainer && searchInput.value) {
                    document.getElementById('no-jobs-message').style.display = 'none';
                }
            } else {
                if (noMsg) noMsg.style.display = 'none';
                jobs.forEach(job => container.appendChild(createJobCard(job, isEmployerView)));
            }
        }

        function listenForJobs() {
            if (jobsUnsubscribe) jobsUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/public/data/jobs`));
            jobsUnsubscribe = onSnapshot(q, (snapshot) => {
                allJobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayJobs(allJobs, jobListingsContainer, false);
                if (userRole === 'employer') fetchEmployerJobs();
                if (snapshot.empty) {
                    seedDatabase();
                }
            }, (error) => {
                console.error("Error listening for jobs:", error);
            });
        }
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredJobs = allJobs.filter(job => 
                (job.title && job.title.toLowerCase().includes(searchTerm)) ||
                (job.companyName && job.companyName.toLowerCase().includes(searchTerm)) ||
                (job.location && job.location.toLowerCase().includes(searchTerm))
            );
            displayJobs(filteredJobs, jobListingsContainer, false);
        });

        function fetchEmployerJobs() {
            if (!currentUser) return;
            const employerJobs = allJobs.filter(job => job.postedBy === currentUser.uid);
            displayJobs(employerJobs, employerJobsContainer, true);
        }

        async function applyForJob(jobId) {
            if (!currentUser) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}`);
            const userDoc = await getDoc(userDocRef);
            if (!userDoc.data().name) {
                alert("Please complete your profile before applying for jobs.");
                showView('profile', 'seeker');
                renderProfileForm();
                return;
            }
            const jobDocRef = doc(db, `artifacts/${appId}/public/data/jobs/${jobId}`);
            await updateDoc(jobDocRef, { applications: arrayUnion(currentUser.uid) });
        }
        
        // --- Modal Functions ---
        function openJobPostModal(referral = null) {
            postJobModalContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg no-scrollbar overflow-y-auto max-h-full">
                    <h3 class="text-2xl font-bold mb-6 text-slate-800">Post a New Job</h3>
                    <form id="post-job-form" class="space-y-4">
                        <input type="hidden" id="referral-id" value="${referral ? referral.id : ''}">
                        <div><label for="job-title" class="block text-sm font-medium text-slate-600">Job Title</label><input type="text" id="job-title" required class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field" value="${referral ? (referral.details || '') : ''}"></div>
                        <div><label for="company-name" class="block text-sm font-medium text-slate-600">Organization / Business Name</label><input type="text" id="company-name" required class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field" value="${referral ? (referral.shopName || '') : ''}"></div>
                        <div><label for="job-location" class="block text-sm font-medium text-slate-600">Location</label><input type="text" id="job-location" required class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field" value="${referral ? (referral.location || '') : ''}"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="job-pay" class="block text-sm font-medium text-slate-600">Pay Rate</label><input type="text" id="job-pay" required class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field"></div>
                            <div><label for="job-hours" class="block text-sm font-medium text-slate-600">Work Hours</label><input type="text" id="job-hours" required class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field"></div>
                        </div>
                        <div><label for="job-description" class="block text-sm font-medium text-slate-600">Job Description</label><textarea id="job-description" rows="4" required class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field"></textarea></div>
                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="button" class="cancel-button px-6 py-2 rounded-lg font-semibold secondary-button">Cancel</button>
                            <button type="submit" class="px-6 py-2 rounded-lg font-semibold cta-button">Post Job</button>
                        </div>
                    </form>
                </div>`;
            postJobModalContainer.style.display = 'flex';
            postJobModalContainer.querySelector('.cancel-button').addEventListener('click', () => postJobModalContainer.style.display = 'none');
            postJobModalContainer.querySelector('#post-job-form').addEventListener('submit', handleJobPostSubmit);
        }

        async function handleJobPostSubmit(e) {
            e.preventDefault();
            if(!currentUser) return;
            const jobData = {
                title: document.getElementById('job-title').value,
                companyName: document.getElementById('company-name').value,
                location: document.getElementById('job-location').value,
                pay: document.getElementById('job-pay').value,
                hours: document.getElementById('job-hours').value,
                description: document.getElementById('job-description').value,
                postedBy: currentUser.uid,
                createdAt: new Date(),
                applications: []
            };
            await addDoc(collection(db, `artifacts/${appId}/public/data/jobs`), jobData);
            
            const referralId = document.getElementById('referral-id').value;
            if (referralId) {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/referrals/${referralId}`));
            }
            
            postJobModalContainer.style.display = 'none';
        }

        function openReferralModal() {
            referJobModalContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg">
                    <h3 class="text-2xl font-bold mb-6 text-slate-800">Refer a Job Lead</h3>
                    <form id="refer-job-form" class="space-y-4">
                        <div><label for="refer-shop-name" class="block text-sm font-medium text-slate-600">Organization / Business Name</label><input type="text" id="refer-shop-name" required class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field"></div>
                        <div><label for="refer-location" class="block text-sm font-medium text-slate-600">Location</label><input type="text" id="refer-location" required class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field"></div>
                        <div><label for="refer-details" class="block text-sm font-medium text-slate-600">Details (e.g., "Hiring cashier, saw sign")</label><textarea id="refer-details" rows="3" required class="mt-1 w-full px-4 py-2 rounded-lg focus:ring-2 input-field"></textarea></div>
                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="button" class="cancel-button px-6 py-2 rounded-lg font-semibold secondary-button">Cancel</button>
                            <button type="submit" class="px-6 py-2 rounded-lg font-semibold cta-button">Submit Referral</button>
                        </div>
                    </form>
                </div>`;
            referJobModalContainer.style.display = 'flex';
            referJobModalContainer.querySelector('.cancel-button').addEventListener('click', () => referJobModalContainer.style.display = 'none');
            referJobModalContainer.querySelector('#refer-job-form').addEventListener('submit', handleReferralSubmit);
        }

        async function handleReferralSubmit(e) {
            e.preventDefault();
            const referralData = {
                shopName: document.getElementById('refer-shop-name').value,
                location: document.getElementById('refer-location').value,
                details: document.getElementById('refer-details').value,
                referredAt: new Date(),
                status: 'pending'
            };
            await addDoc(collection(db, `artifacts/${appId}/public/data/referrals`), referralData);
            referJobModalContainer.style.display = 'none';
            alert('Thank you! Your referral has been submitted.');
        }

        // --- Admin Functions ---
        function listenForReferrals() {
            if (referralsUnsubscribe) referralsUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/public/data/referrals`));
            referralsUnsubscribe = onSnapshot(q, (snapshot) => {
                referralListingsContainer.innerHTML = '';
                document.getElementById('no-referrals-message').style.display = snapshot.empty ? 'block' : 'none';
                snapshot.forEach(doc => {
                    const referral = { id: doc.id, ...doc.data() };
                    referralListingsContainer.appendChild(createReferralCard(referral));
                });
            });
        }

        function createReferralCard(referral) {
            const card = document.createElement('div');
            card.className = 'referral-card p-6 rounded-lg';
            card.innerHTML = `
                <h3 class="text-lg font-bold text-slate-800">${referral.shopName}</h3>
                <p class="text-sm text-slate-500">${referral.location}</p>
                <p class="text-slate-600 my-3">${referral.details}</p>
                <button class="confirm-button w-full font-bold py-2 cta-button">Confirm & Post Job</button>`;
            card.querySelector('.confirm-button').addEventListener('click', () => openJobPostModal(referral));
            return card;
        }

        // --- Database Seeding ---
        async function seedDatabase() {
            if (!auth.currentUser) {
                console.log("User not signed in yet, skipping seed check.");
                return;
            }
            const jobsRef = collection(db, `artifacts/${appId}/public/data/jobs`);
            const q = query(jobsRef);
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                console.log("Database is empty. Seeding with sample jobs...");
                const batch = writeBatch(db);
                const sampleJobs = [
                    { title: "Barista for Weekend Shifts", companyName: "Koramangala Coffee House", location: "Koramangala, Bengaluru", pay: "₹250/hour", hours: "Sat-Sun, 8am-2pm", description: "Looking for an experienced barista to handle our busy weekend rush. Must be skilled in latte art and customer service.", postedBy: "sample_employer_1", createdAt: new Date(), applications: [] },
                    { title: "Part-Time Retail Assistant", companyName: "Indiranagar Boutique", location: "Indiranagar, Bengaluru", pay: "₹200/hour", hours: "3 days/week, 4pm-9pm", description: "Assist customers, manage inventory, and help with store upkeep. Great for students.", postedBy: "sample_employer_2", createdAt: new Date(), applications: [] },
                    { title: "Event Staff for Tech Conference", companyName: "Bengaluru Expo Center", location: "Whitefield, Bengaluru", pay: "₹1500/day", hours: "Full day, Oct 5-6", description: "Help with registration, guide attendees, and provide general support for a major tech conference.", postedBy: "sample_employer_3", createdAt: new Date(), applications: [] },
                    { title: "Data Entry Operator (Remote)", companyName: "DataFlow Solutions", location: "Remote", pay: "₹15,000/month", hours: "Flexible 20 hours/week", description: "Part-time remote data entry role. Requires attention to detail and basic computer skills.", postedBy: "sample_employer_4", createdAt: new Date(), applications: [] }
                ];
                sampleJobs.forEach(job => {
                    const newJobRef = doc(jobsRef);
                    batch.set(newJobRef, job);
                });
                await batch.commit();
                console.log("Seeding complete.");
            }
        }


        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('open-post-job-modal-button').addEventListener('click', () => openJobPostModal());
        });

    </script>
</body>
</html>
